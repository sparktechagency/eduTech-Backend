name: Update README

on:
  schedule:
    - cron: '0 0 */2 * *'  
  workflow_dispatch:

# permissions fix (Organization Repo)
permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Update README with recent activity
        uses: jamesgeorge007/github-activity-readme@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          COMMIT_MSG: '‚ö° Update README with recent activity'
          MAX_LINES: 5

  update-quote:
    needs: update-readme
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # Python setup
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # delete action remove to custom python script
      - name: Update Quote with Python
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # necessary library install
          pip install requests

          # run python script to fetch quote and update README
          python -c "
          import requests
          import re
          import os

          try:
              response = requests.get('https://api.quotable.io/random?maxLength=50')
              if response.status_code == 200:
                  data = response.json()
                  quote = f\"{data['content']} - {data['author']}\"
                  print(f'Got quote: {quote}')
                  
                  # README update logic
                  with open('README.md', 'r') as f:
                      content = f.read()
                  
                  # Regex used to replace the existing quote (if any) with the new one
                  new_content = re.sub(
                      r'.*',
                      f'\n{quote}\n',
                      content,
                      flags=re.DOTALL
                  )
                  
                  with open('README.md', 'w') as f:
                      f.write(new_content)
              else:
                  print('Failed to fetch quote')
          except Exception as e:
              print(f'Error: {e}')
          "

      # ‡ß™. commit and push
      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # If there are no changes, do not throw an error
          git commit -m "üìù Update quote" || exit 0
          git push